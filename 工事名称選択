' ユーザーフォーム: 工事名称選択

Option Explicit

'--- 初期設定 ---
' Trueにすると、下のテスト用ファイルパスが使われる（開発者向け）
Private Const IS_TEST_MODE As Boolean = True
' テスト時に使用する「工事番号管理表.xlsm」の場所
Private Const m_TEST_FILE_PATH_FOR_TEST As String = "Z:\Users\n-machida\Desktop\工事番号管理表.xlsm"

'--- プログラム内で固定的に使う文字（定数） ---
Private Const m_KANRI_MASTER_NAME As String = "管理マスタ"
Private Const m_PATH_CELL As String = "A36"
Private Const MASTER_TARGET_SHEET_NAME_CELL As String = "G3"

'--- このフォームを呼び出した元のプログラムに、選択結果を渡すための変数 ---
Public selectedKoujiName As String ' 決定された「工事名称」を格納
Public SelectedTantousha As String ' 決定された「担当者」を格納
Public Cancelled As Boolean         ' キャンセルされたかどうかを格納 (True = キャンセル)

'--- このフォーム内だけで使う変数 ---
' 高速化のため、担当者リストを一時保存する変数
Private m_CachedStaffList As Variant
' 高速化のため、工事リストを「担当者→工事名称」の階層で一時保存する変数
Private m_CachedKoujiList As Object
' ユーザーがリストで選択した工事名称を、OKボタンが押されるまで一時的に保持する変数
Private m_selectedKoujiNameTemp As String

Private Sub Label3_Click()

End Sub

'================================================================================
' フォームが開かれる瞬間の準備処理（データ読み込みなど）
'================================================================================
Private Sub UserForm_Initialize()
    Dim wbTarget_Init As Workbook
    Dim wsMaster_Init As Worksheet
    Dim targetSheetName As String

    ' --- フォームの初期状態を設定 ---
    Me.Cancelled = True ' 最初は「キャンセルされた」状態にしておく
    Me.OK.Enabled = False ' まだ何も選択されていないので、OKボタンは押せなくしておく
    Me.工事名称.Clear
    m_selectedKoujiNameTemp = ""
    ' 工事リストを格納するための高速な入れ物 (Dictionary) を準備
    Set m_CachedKoujiList = CreateObject("Scripting.Dictionary")

    ' エラーが発生した場合は「ErrorHandlerInit」へジャンプ
    On Error GoTo ErrorHandlerInit

    ' --- 外部ファイルから担当者と工事の全リストを読み込む ---
    Dim targetFilePath As String
    If IS_TEST_MODE Then
        targetFilePath = m_TEST_FILE_PATH_FOR_TEST
    Else
        targetFilePath = Trim(CStr(ThisWorkbook.Sheets("入力フォーム").Range(m_PATH_CELL).Value))
    End If

    If Dir(targetFilePath) = "" Then
        MsgBox "指定ファイルが見つかりません。", vbCritical
        Unload Me
        Exit Sub
    End If

    ' 読み取り専用でファイルを開く
    Set wbTarget_Init = Application.Workbooks.Open(fileName:=targetFilePath, ReadOnly:=True, UpdateLinks:=0)

    ' 「管理マスタ」シートから担当者リストを取得し、ドロップダウンに設定
    If Not SheetExists(wbTarget_Init, m_KANRI_MASTER_NAME) Then
        MsgBox "外部ファイルに「" & m_KANRI_MASTER_NAME & "」が見つかりません。", vbCritical
        GoTo FinalizeInit
    End If
    Set wsMaster_Init = wbTarget_Init.Sheets(m_KANRI_MASTER_NAME)

    m_CachedStaffList = wsMaster_Init.Range("A2:A" & wsMaster_Init.Cells(wsMaster_Init.Rows.count, "A").End(xlUp).Row).Value
    Me.担当者.List = m_CachedStaffList

    ' データの本体があるシート名を取得
    targetSheetName = Trim(CStr(wsMaster_Init.Range(MASTER_TARGET_SHEET_NAME_CELL).Value))
    If targetSheetName = "" Then
        MsgBox "「" & m_KANRI_MASTER_NAME & "」G3セルに対象シート名が設定されていません。", vbCritical
        GoTo FinalizeInit
    End If

    ' --- 全工事データを読み込み、担当者ごとに整理してキャッシュに保存 ---
    Dim wsTarget As Worksheet
    If Not SheetExists(wbTarget_Init, targetSheetName) Then
        MsgBox "外部ファイルにシート「" & targetSheetName & "」が見つかりません。", vbCritical
        GoTo FinalizeInit
    End If
    Set wsTarget = wbTarget_Init.Sheets(targetSheetName)

    Dim r As Long
    Dim currentStaff As String, currentKoujiName As String
    ' 最終行から上に向かってループ
    For r = wsTarget.Cells(wsTarget.Rows.count, "C").End(xlUp).Row To 2 Step -1
        currentStaff = Trim(CStr(wsTarget.Cells(r, "C").Value))
        currentKoujiName = Trim(CStr(wsTarget.Cells(r, "E").Value))

        If currentStaff <> "" And currentKoujiName <> "" Then
            ' まだキャッシュにない担当者の場合、その担当者用の入れ物を準備
            If Not m_CachedKoujiList.Exists(currentStaff) Then
                m_CachedKoujiList.Add currentStaff, CreateObject("Scripting.Dictionary")
            End If
            ' 担当者ごとの入れ物に、重複しないように工事名称を追加
            If Not m_CachedKoujiList(currentStaff).Exists(currentKoujiName) Then
                m_CachedKoujiList(currentStaff).Add currentKoujiName, True
            End If
        End If
    Next r

FinalizeInit: ' 終了処理
    ' 開いたファイルを閉じる
    If Not wbTarget_Init Is Nothing Then wbTarget_Init.Close SaveChanges:=False
    Exit Sub

ErrorHandlerInit: ' エラー発生時の処理
    MsgBox "初期化中に予期せぬエラー発生: " & Err.Description, vbCritical
    Resume FinalizeInit
End Sub

'================================================================================
' 「担当者」ドロップダウンが変更されたときの処理
'================================================================================
Private Sub 担当者_Change()
    ' --- 担当者が選ばれたら、関連する工事名称リストに絞り込む ---
    Me.工事名称.Clear ' いったん工事名称リストを空にする
    Me.OK.Enabled = False ' OKボタンを押せなくする
    m_selectedKoujiNameTemp = ""

    ' 担当者の選択が解除されたら、ここで処理を終了
    If Me.担当者.ListIndex = -1 Then Exit Sub

    ' 選択された担当者名を取得
    Dim selectedStaff As String
    selectedStaff = Trim(Me.担当者.Value)

    ' キャッシュの中から、選ばれた担当者の工事データを探す
    If Not m_CachedKoujiList Is Nothing Then
        If m_CachedKoujiList.Exists(selectedStaff) Then
            ' 見つかった工事名称の一覧をリストボックスに設定
            Me.工事名称.List = m_CachedKoujiList(selectedStaff).Keys
        End If
    End If
End Sub

'================================================================================
' 「工事名称」リストボックスの項目がクリックされたときの処理
'================================================================================
Private Sub 工事名称_Click()
    ' --- 工事名称が選択されたら、OKボタンを押せるようにする ---
    If Me.工事名称.ListIndex > -1 Then
        ' 選択された項目を一時変数に保存
        m_selectedKoujiNameTemp = Me.工事名称.Value
        Me.OK.Enabled = True ' OKボタンを有効化
    Else
        ' 何も選択されていない状態になったら、OKボタンを無効化
        m_selectedKoujiNameTemp = ""
        Me.OK.Enabled = False
    End If
End Sub

'================================================================================
' 「OK」ボタンがクリックされたときの処理
'================================================================================
Private Sub OK_Click()
    ' 一時変数に工事名称が保存されているか（＝リストで項目が選択されているか）をチェック
    If m_selectedKoujiNameTemp = "" Then
        MsgBox "工事名称が選択されていません。", vbExclamation
        Exit Sub
    End If

    ' --- 選択内容をPublic変数にセット ---
    ' これで、フォームを呼び出した元のプログラムが選択結果を受け取れるようになる
    Me.selectedKoujiName = m_selectedKoujiNameTemp
    Me.SelectedTantousha = Me.担当者.Value
    Me.Cancelled = False ' 「キャンセルされなかった」ことを示す

    ' フォームを非表示にする（UnloadではなくHideなのがポイント）
    Me.Hide
End Sub

'================================================================================
' フォーム右上の「×」ボタンで閉じられそうになったときの処理
'================================================================================
Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    ' 「×」ボタンで閉じられた場合のみ処理を行う
    If CloseMode = vbFormControlMenu Then
        ' キャンセルされたことを明確にする
        Me.Cancelled = True
        ' フォームを非表示にする
        Me.Hide
        ' フォームが完全に閉じてメモリから解放されるのを防ぐ
        Cancel = 1
    End If
End Sub

' 補足：シート存在チェック用の関数
Private Function SheetExists(ByVal wb As Workbook, ByVal sheetName As String) As Boolean
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Sheets(sheetName)
    On Error GoTo 0
    SheetExists = Not ws Is Nothing
End Function
